Bootstrap: docker
From: ubuntu:22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    # Add Go and Cargo to PATH for language runtimes
    export PATH=/root/.cargo/bin:/usr/local/go/bin:$PATH
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export WORKDIR=/workspace
    export PYTHONUNBUFFERED=1
    # Bind the repository root to /workspace when running.
    # Ensure Python can import the top-level codegeex package.
    export PYTHONPATH=/workspace:$PYTHONPATH
    # Ensure Node.js can resolve globally installed modules like js-md5.
    export NODE_PATH=/usr/local/lib/node_modules

%files
    # Stage Python requirements used by the evaluator
    codegeex/benchmark/humaneval-x/requirements.txt /opt/humanevalx/requirements.txt

%post
    set -e
    apt-get update
    apt-get install -y --no-install-recommends \
        software-properties-common \
        ca-certificates \
        gnupg \
        curl wget \
        build-essential \
        git \
        python3 python3-pip \
        g++-11 \
        libboost-all-dev \
        golang-go \
        libssl-dev \
        pkg-config
    rm -rf /var/lib/apt/lists/*

    # OpenJDK 18（PPA。安定性が必要なら Temurin に置き換え可）
    add-apt-repository ppa:openjdk-r/ppa -y
    apt-get update
    apt-get install -y --no-install-recommends openjdk-18-jdk
    rm -rf /var/lib/apt/lists/*

    # Node.js 16 + pin to 16.14.0 + js-md5
    curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
    apt-get update
    apt-get install -y --no-install-recommends nodejs
    npm install -g n
    n 16.14.0
    npm install -g js-md5@0.7.3
    rm -rf /var/lib/apt/lists/*

    # Rust toolchain (for Rust problem evaluation via cargo)
    curl https://sh.rustup.rs -sSf | sh -s -- -y
    . /root/.cargo/env
    rustup default stable

    # Python packages for evaluator
    python3 -m pip install --no-cache-dir -r /opt/humanevalx/requirements.txt

    mkdir -p /workspace

%runscript
    # 実行前提：ホストのリポジトリルート（このファイルの2階層上）を
    # -B <repo-root>:/workspace にバインドし、評価スクリプトを実行します。
    # import 解決のため PYTHONPATH に /workspace（リポジトリルート）を通します。
    cd /workspace
    export PYTHONPATH=/workspace:${PYTHONPATH}
    exec python3 codegeex/benchmark/humaneval-x/evaluate_humaneval_x.py "$@"

%labels
    Maintainer "you"
    Description "Humaneval-X evaluator environment (Ubuntu 22.04)"
