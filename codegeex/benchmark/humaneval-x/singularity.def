Bootstrap: docker
From: ubuntu:22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    # Add Go and Cargo to PATH for language runtimes
    export PATH=/root/.cargo/bin:/usr/local/go/bin:$PATH
    export GOPATH=/opt/humanevalx/go
    export GOMODCACHE=/opt/humanevalx/go/pkg/mod
    export HUMANEVALX_GO_MOD=/opt/humanevalx/go_mod
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export WORKDIR=/workspace
    export PYTHONUNBUFFERED=1
    # Bind the repository root to /workspace when running.
    # Ensure Python can import the top-level codegeex package.
    export PYTHONPATH=/workspace:$PYTHONPATH
    # Ensure Node.js can resolve globally installed modules like js-md5.
    # Include common global locations used by different npm prefixes.
    export NODE_PATH=/usr/local/lib/node_modules:/usr/lib/node_modules

%files
    # Copy project requirements into the image at build time
    requirements.txt /opt/humanevalx/requirements.txt

%setup
    # Ensure destination directory for copied files exists in image rootfs
    mkdir -p "$SINGULARITY_ROOTFS/opt/humanevalx"

%post
    set -eu
    # Keep all apt operations noninteractive during build to avoid prompts
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

    # Simple retry helper for flaky network operations
    retry() {
        r_n=0
        r_try=5
        r_delay=3
        while true; do
            "$@"
            exit_code=$?
            if [ $exit_code -eq 0 ]; then
                return 0
            fi
            r_n=$((r_n+1))
            if [ $r_n -ge $r_try ]; then
                echo "Command failed after $r_n attempts: $*" >&2
                return $exit_code
            fi
            echo "Retry $r_n/$r_try after failure ($exit_code): $*" >&2
            sleep $((r_delay*r_n))
        done
    }
    retry apt-get update
    retry apt-get install -y --no-install-recommends \
        software-properties-common \
        ca-certificates \
        gnupg \
        curl wget \
        build-essential \
        git \
        python3 python3-pip \
        g++-11 \
        libboost-all-dev \
        golang-go \
        libssl-dev \
        pkg-config
    rm -rf /var/lib/apt/lists/*

    # Use Ubuntu 22.04 default OpenJDK (17) to avoid PPA instability
    retry apt-get update
    retry apt-get install -y --no-install-recommends openjdk-17-jdk
    rm -rf /var/lib/apt/lists/*

    # Node.js (install via NodeSource 16.x) + js-md5
    retry bash -lc 'curl -fsSL https://deb.nodesource.com/setup_16.x | bash -'
    retry apt-get update
    retry apt-get install -y --no-install-recommends nodejs
    npm config set fund false --global || true
    npm config set audit false --global || true
    retry npm install -g js-md5@0.7.3
    rm -rf /var/lib/apt/lists/*

    # Rust toolchain via Ubuntu packages (faster and more reliable on remote builders)
    retry apt-get update
    retry apt-get install -y --no-install-recommends rustc cargo
    rm -rf /var/lib/apt/lists/*

    # Pre-fetch Go module dependencies used by HumanEval-X harness
    export GOPATH=/opt/humanevalx/go
    export GOMODCACHE=/opt/humanevalx/go/pkg/mod
    mkdir -p "$GOMODCACHE"
    mkdir -p /opt/humanevalx/go_mod
    cd /opt/humanevalx/go_mod
    cat <<'EOF' > go.mod
module humanevalx

go 1.18

require github.com/stretchr/testify v1.8.2
EOF
    GO111MODULE=on go mod tidy
    GO111MODULE=on go mod download

    # Python packages for evaluator (from repository requirements copied via %files)
    mkdir -p /opt/humanevalx
    retry python3 -m pip install --no-cache-dir -r /opt/humanevalx/requirements.txt

    mkdir -p /workspace

%runscript
    # 実行前提：ホストのリポジトリルート（このファイルの2階層上）を
    # -B <repo-root>:/workspace にバインドし、評価スクリプトを実行します。
    # import 解決のため PYTHONPATH に /workspace（リポジトリルート）を通します。
    cd /workspace
    export PYTHONPATH=/workspace:${PYTHONPATH}
    exec python3 codegeex/benchmark/humaneval-x/evaluate_humaneval_x.py "$@"

%labels
    Maintainer "you"
    Description "Humaneval-X evaluator environment (Ubuntu 22.04)"
