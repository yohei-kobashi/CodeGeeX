Bootstrap: docker
From: ubuntu:22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    # Add Go and Cargo to PATH for language runtimes
    export PATH=/root/.cargo/bin:/usr/local/go/bin:$PATH
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export WORKDIR=/workspace
    export PYTHONUNBUFFERED=1
    # Bind the repository root to /workspace when running.
    # Ensure Python can import the top-level codegeex package.
    export PYTHONPATH=/workspace:$PYTHONPATH
    # Ensure Node.js can resolve globally installed modules like js-md5.
    export NODE_PATH=/usr/local/lib/node_modules

%files
    # Stage Python requirements used by the evaluator
    codegeex/benchmark/humaneval-x/requirements.txt /opt/humanevalx/requirements.txt

%post
    set -euo pipefail
    # Keep all apt operations noninteractive during build to avoid prompts
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

    # Simple retry helper for flaky network operations
    retry() {
        local n=0
        local try=5
        local delay=3
        until "$@"; do
            exit_code=$?
            n=$((n+1))
            if [ $n -ge $try ]; then
                echo "Command failed after $n attempts: $*" >&2
                return $exit_code
            fi
            echo "Retry $n/$try after failure ($exit_code): $*" >&2
            sleep $((delay*n))
        done
    }
    retry apt-get update
    retry apt-get install -y --no-install-recommends \
        software-properties-common \
        ca-certificates \
        gnupg \
        curl wget \
        build-essential \
        git \
        python3 python3-pip \
        g++-11 \
        libboost-all-dev \
        golang-go \
        libssl-dev \
        pkg-config
    rm -rf /var/lib/apt/lists/*

    # Use Ubuntu 22.04 default OpenJDK (17) to avoid PPA instability
    retry apt-get update
    retry apt-get install -y --no-install-recommends openjdk-17-jdk
    rm -rf /var/lib/apt/lists/*

    # Node.js (install via NodeSource 16.x) + js-md5
    retry bash -lc 'curl -fsSL https://deb.nodesource.com/setup_16.x | bash -'
    retry apt-get update
    retry apt-get install -y --no-install-recommends nodejs
    npm config set fund false --global || true
    npm config set audit false --global || true
    retry npm install -g js-md5@0.7.3
    rm -rf /var/lib/apt/lists/*

    # Rust toolchain via Ubuntu packages (faster and more reliable on remote builders)
    retry apt-get update
    retry apt-get install -y --no-install-recommends rustc cargo
    rm -rf /var/lib/apt/lists/*

    # Python packages for evaluator
    retry python3 -m pip install --no-cache-dir -r /opt/humanevalx/requirements.txt

    mkdir -p /workspace

%runscript
    # 実行前提：ホストのリポジトリルート（このファイルの2階層上）を
    # -B <repo-root>:/workspace にバインドし、評価スクリプトを実行します。
    # import 解決のため PYTHONPATH に /workspace（リポジトリルート）を通します。
    cd /workspace
    export PYTHONPATH=/workspace:${PYTHONPATH}
    exec python3 codegeex/benchmark/humaneval-x/evaluate_humaneval_x.py "$@"

%labels
    Maintainer "you"
    Description "Humaneval-X evaluator environment (Ubuntu 22.04)"
